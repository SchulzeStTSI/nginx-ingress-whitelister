kind: Job
apiVersion: batch/v1
metadata:
  name: {{ .Release.Name }}-bot-delete-hook
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-delete
spec:
  template: 
    spec:
      serviceAccountName: {{ .Release.Name }}-service-account
      containers:
        - name: {{ .Release.Name }}-bot-delete-hook
          image: alpine
          env: 
            - name: TAG
              value: {{ .Values.config.tag }}
            - name: REPO
              value: {{ .Values.config.repo }}
            - name: CONTROLLER_CONFIG_NAMESPACE
              value: {{ .Values.controller.namespace }}
            - name: CONTROLLER_CONFIG_MAP
              value: {{ .Values.controller.config.map }}
            - name: BUNDLE_SECRET
              value: {{ .Values.certificates.secret }}
            - name: CONFIG_SEPERATOR
              value: {{ .Values.config.seperator | quote }}
            - name: INGRESS_NAME
              value: {{ .Values.ingress.name }}
            - name: INGRESS_NAMESPACE
              value: {{ .Values.ingress.namespace }}
          command: ["sh", "-c", "apk add --update py-pip	> /dev/null;apk add --update py-pip	> /dev/null;apk add --update git > /dev/null; apk add --update bash > /dev/null;git clone $REPO --branch $TAG bot;  pip install -r /bot/requirements.txt > /dev/null;python /bot/removeFingerprints.py; python /bot/removeCaBundle.py;python /bot/removeIngressAnnotation.py"]
          imagePullPolicy: Always
      restartPolicy: Never
